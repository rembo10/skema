name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Setup Cachix
      uses: cachix/cachix-action@v15
      with:
        name: nix-community
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        skipPush: true

    - name: Restore cached dependencies
      id: cache-cabal-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          server/dist-newstyle
          ~/.cabal/packages
          ~/.cabal/store
        key: ${{ runner.os }}-cabal-${{ hashFiles('**/flake.lock', 'server/cabal.project', 'server/skema.cabal') }}

    - name: Build and run tests
      run: nix develop --command bash -c "cd server && cabal test --test-show-details=direct"

    - name: Save cached dependencies
      if: always() && steps.cache-cabal-restore.outputs.cache-hit != 'true'
      uses: actions/cache/save@v4
      with:
        path: |
          server/dist-newstyle
          ~/.cabal/packages
          ~/.cabal/store
        key: ${{ steps.cache-cabal-restore.outputs.cache-primary-key }}
